<!doctype html>
<!-- Treningsapp -->
<html>

    <head>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://www.parsecdn.com/js/parse-latest.js"></script>
        <script src="//www.parsecdn.com/js/parse-1.6.14.min.js"></script>
        <link rel="stylesheet" type="text/css" href="./style.css" />
        <link rel="stylesheet" type="text/css" href="./feed.css" />
        <link rel="stylesheet" href="./font-awesome-4.6.3/css/font-awesome.min.css">
        <title>Klubben</title>


    </head>

    <body>
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

        <div class="nav">

            <img src="./img/Ikon.png">
             <a class="navn" href="newsFeed.html">Klubben</a>

            <ul>

                <li>
                    <div class="loggut">
                        <a href="registration.html" class="fa fa-sign-out" id="signOut" aria-hidden="true" onclick="logOut()"></a>

                    </div>
                     <a href="../pages/reports.html" id="velvaere">Forberedelser</a>
                     <a href="../pages/reports.html" id="trening">Evaluering</a>
                     <a href="../stats.html" id="statistikk">Statistikk</a>
                </li>

            </ul>

        </div>

        <div id="side-menu">

            <div id="profile">
                <ul id="profile-pb">
                </ul>
                <p id="brukernavn"></p>
                <ul id="list-role">
                </ul>
                <p id="changePB">Bytt profilbilde:</p>
                <input id="pb-file" type="file" />
            </div>

        </div>

        <div id="request">
            <ul id="list-req">
            </ul>
        </div>


        <script type="text/javascript">
            //Parse.initialize("wSHRpQQxW6jgmxRQV8UXogZcOiRvO8s8VoVmlMYI");
             //Parse.serverURL = 'https://klubbenheroku.herokuapp.com/parse';
            Parse.initialize("wSHRpQQxW6jgmxRQV8UXogZcOiRvO8s8VoVmlMYI", "imVCWFzFX4fVRGcqX8ioidD686IPb5ELzHd3WkJw");


            function checkLogin() {
                if (Parse.User.current) {
                    $("#brukernavn").html(Parse.User.current().get("name"));
                } else {
                    $("#brukernavn").html("");
                }
            }

            var currentUser = Parse.User.current();
            if (currentUser) {

            } else {
                location.href = "registration.html";
            }

            checkLogin();

            function logOut() {
                Parse.User.logOut(
                    console.log("Logger ut"));

            }

            var klubbID;

            function roles() {
                klubbID = Parse.User.current().get("team").id;
                var Query = Parse.Object.extend("data_" + klubbID + "_Members");
                var query = new Parse.Query(Query);
                var outputRole = "";
                var outputReq = "";
                query.equalTo("user", Parse.User.current());
                query.find({
                        success: function(objects) {
                            console.log(objects.length);
                            var role = objects[0].get("role");
                            console.log(role);

                            outputRole += "<div id=\"userRole\">";
                            outputRole += "<p>" + role + "</p>";
                            outputRole += "</div>"

                            $("#list-role").html(outputRole);

                            if (role == "admin") {

                            } else if (role == "trener") {
                                document.getElementById("trening").remove();
                                document.getElementById("velvaere").remove();
                            } else {
                                document.getElementById("statistikk").remove();
                            }

                            if ((role == "admin") || (role == "trener")) {

                                var queryQ = new Parse.Query(Query);
                                queryQ.descending("createdAt");
                                queryQ.include("user");
                                queryQ.find({

                                        success: function(objects) {

                                            outputReq += '<h1 id="request-heading">' + "Forespørsler" + "</h1>";

                                            for (var a in objects) {
                                                objects[a].toJSON();
                                                var content = objects[a].get("accepted");
                                                var user = objects[a].get("user");
                                                var name = user.get("name");

                                                var accept = objects[a].get("accepted");

                                                if (accept == false) {
                                                    console.log(name);

                                                    outputReq += "<div id=\"all-requests\">";
                                                    outputReq += "<p>" + name + "</p>";
                                                    outputReq += "<button>" + "Avslå" + "</button>";
                                                    outputReq += '<button name="' + name + '" type="button" onclick="acceptPlayerRequest(name);">' + 'Godkjenn' + '</button>';
                                                    outputReq += "</div>"
                                                }


                                            }
                                            $("#list-req").html(outputReq);

                                        },
                                        error: function(error) {
                                            console.log("Query error:" + error.message);
                                        }
                                    });


                            }
                            $("#list-req").html(outputReq);

                        },
                        error: function(error) {
                            alert("Error: " + error.code + " " + error.message);
                        }
                    });
            }
            roles();

            function acceptPlayerRequest(id) {
                var query = Parse.Object.extend("data_" + klubbID + "_Members");

                var queryQ = new Parse.Query(query);
                queryQ.descending("createdAt");
                queryQ.include("user");
                queryQ.find({

                        success: function(objects) {

                            for (var a in objects) {

                                var content = objects[a].get("accepted");
                                var user = objects[a].get("user");
                                var name = user.get("name");

                                if (name == id) {
                                    console.log(name);
                                    objects[a].set("accepted", true);
                                    objects[a].set("role", "spiller");
                                    Parse.Cloud.run("setPlayersTeam", {
                                            user: "teamId"
                                        });

                                    objects[a].save(null, {
                                            success: function() {
                                                console.log("Heia Heia");
                                            }
                                        });

                                }


                            }

                        },
                        error: function(error) {
                            console.log("Query error:" + error.message);
                        }
                    });

                console.log(id);

            }

            console.log(klubbID);
            localStorage.setItem("clubId", klubbID);
        </script>

        <div class="form">

            <form name="post">
                <div id="tekstboks">
                    <ul id="list-pb">

                    </ul>

                    <textarea rows="4" cols="60" name="text" placeholder="Skriv ditt innlegg her"></textarea>
                </div>
                <input id="post-file" class="imageInput" type="file" />
                <button name="submit" type="button" onclick="Submit()">Publiser</button>
            </form>
        </div>

        <div class="posts">
            <ul id="list-posts">

            </ul>
        </div>


        <script type="text/javascript">
            //Parse.initialize("wSHRpQQxW6jgmxRQV8UXogZcOiRvO8s8VoVmlMYI");
             //Parse.serverURL = 'https://klubbenheroku.herokuapp.com/parse';
            Parse.initialize("wSHRpQQxW6jgmxRQV8UXogZcOiRvO8s8VoVmlMYI", "imVCWFzFX4fVRGcqX8ioidD686IPb5ELzHd3WkJw");

            var post1 = Parse.Object.extend("Post");
            var Post = Parse.Object.extend("data_" + klubbID + "_Posts");


            function Submit() {
                var newPost = new post1();


                var text = document.post.elements[0].value;
                var bilde = document.post.elements[1];
                var bildePath = document.post.elements[1].value;
                var bildeNavn = bildePath.split("\\").pop();


                newPost.set("content", text);
                newPost.set("author", Parse.User.current());
                newPost.set("clubId", klubbID);

                if (bilde.files.length > 0) {
                    var file = bilde.files[0];
                    var newFile = new Parse.File(bildeNavn, file);

                    newFile.save({
                            success: function() {

                            },
                            error: function(file, error) {
                                console.log("Files Save Error:" + error.message);
                            }
                        }).then(function(theFile) {
                            newPost.set("Image", theFile);
                            newPost.save({

                                    suceess: function() {
                                        getPosts();
                                    },
                                    error: function(error) {
                                        console.log("Post Save with File Error:" + error.message);
                                    }

                                });
                        });
                } else {

                    newPost.save(null, {
                            success: function(newPost) {
                                console.log("Fantastisk");
                                getPosts();
                            },
                            error: function(newPost, error) {
                                console.log("Error:" + error.message);
                            }
                        });
                }

                console.log(text);
                console.log(Parse.User.current());
                console.log(klubbID);


            }

            function getPB() {
                var outputImg = "";

                var user = Parse.User.current();
                var userImg = "";
                var noUserImg = "";
                if (user.get("profileImage_small")) {
                    var brukerPB = user.get("profileImage_small");
                    var PBUrl = brukerPB.url();
                    console.log("Url:" + PBUrl);
                    userImg = "<img src='" + PBUrl + "'>";
                } else if (user.get("profileImage_small") != null) {
                    noUserImg = '<img src="./img/2000px-AWS_Simple_Icons_Non-Service_Specific_User.svg.png">';
                    console.log("Supert");
                }

                outputImg += "<div id=\"userPB\">";
                outputImg += userImg;
                outputImg += noUserImg;
                outputImg += "</div>"

                $("#list-pb").html(outputImg);
                $("#profile-pb").html(outputImg);
            }

            getPB();


            function getPosts() {
                var query = new Parse.Query(Post);
                query.descending("createdAt");
                query.include("author");
                query.find({

                        success: function(results) {
                            var output = "";

                            for (var i in results) {
                                results[i].toJSON();
                                var content = results[i].get("content");
                                var author = results[i].get("author");
                                var name = "Anonymous";

                                var date = results[i].get("createdAt");
                                var dato = date.toString();
                                var datoen = dato.substring(4, 15);


                                if (author != null) {
                                    name = author.get("name");
                                }

                                var pB = "";
                                var userPB = "";
                                if (author.get("profileImage_small")) {
                                    var bilde = author.get("profileImage_small");
                                    var url1 = bilde.url();
                                    pB = "<img src='" + url1 + "'>";
                                } else {
                                    userPB = '<img src="../img/2000px-AWS_Simple_Icons_Non-Service_Specific_User.svg.png">';

                                }


                                var img = "";
                                if (results[i].get("Image")) {
                                    var file = results[i].get("Image");
                                    var url = file.url();
                                    //console.log("url: " + url);
                                    img = "<img src='" + url + "'>";
                                }

                                output += "<div id=\"feedCell\">";
                                output += "<div id=\"profilBilde\">";
                                output += pB;
                                output += userPB;
                                output += "</div>"
                                output += "<h4>" + name + "</h4>";
                                output += "<h5>" + "Skrevet: " + datoen + "</h5>";
                                output += "<p>" + content + "</p>";
                                output += img;
                                output += "</div>"
                            }
                            $("#list-posts").html(output);

                        },
                        error: function(error) {
                            console.log("Query error:" + error.message);
                        }
                    });
            }

            getPosts();
        </script>



        <div class="footer2">
            <p>Copyright &copy; Klubben 2016</p>
        </div>


    </body>

</html>